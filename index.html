<!DOCTYPE html>
<html>
<head>

    <link href="https://fonts.googleapis.com/css?family=M+PLUS+Rounded+1c|Varela+Round&amp;display=swap" rel="stylesheet">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>

    <title>
        Contrarian Sticker Generator
    </title>
    <style>
        #main {
            display: block;
            width: 100%;
        }
        input[type=text] {
            border: none;
            width: 100%;
            padding: 12px 20px;
            margin: 8px 0;
            box-sizing: border-box;
            background-color: #ffff00;
            color: black;
        }
        
        button[type=button] {
            border: solid;
            border-radius: 2px;
            width: 100%;
            padding: 12px 20px;
            margin: 8px 0;
            box-sizing: border-box;
            background-color: #ffff00;
            color: black;
        }
    </style>
</head>

<body>
    <div id="main" role="main">
        <canvas id="smileCanvas" width="100" height="100" style="border:1px solid #000000;">
            < !-- Provide fallback -->
        </canvas>
    </div>
    <input type="text" placeholder="Gegen Regen" id="lowerTextInput" name="lower text" maxlength="30" size="10">
    <input type="text" placeholder="Pro Klo" id="upperTextInput" name="upper text" maxlength="30" size="10">

    <a id="download" download="sticker.png">
        <button type="button" onClick="downloadImage()">Download</button>
    </a>

    <script>
        function drawTextAlongArc(context, str, centerX, centerY, radius, angle, low=true) {
            context.save();
            context.translate(centerX, centerY);
            context.rotate(-1 * angle / 2);
            var strLen = context.measureText(str).width;
            for (var n = 0; n < str.length; n++) {
                var index = low ? str.length - n - 1 : n;
                var letter = str[index];
                var letterLength = context.measureText(letter).width;
                var rotation = (letterLength / strLen) / 2;
                context.rotate(angle * rotation);
                context.save();
                var factor = low ? 1 : -1;
                context.translate(0, factor * radius);
                context.textBaseline = 'middle';
                context.fillText(letter, 0, 0);
                context.restore();
                context.rotate(angle * rotation);
            }
            context.restore();
        }

        function smileCanvas() {
            var c = $('#smileCanvas');
            var ct = c.get(0).getContext('2d');
            var container = $(c).parent();
            c.attr('width', $(container).width());
            c.attr('height', $(container).width());

            var canvas = document.getElementById('smileCanvas');

            var context = canvas.getContext('2d');

            context.fillStyle = "white";
            context.fillRect(0, 0, canvas.width, canvas.height);

            var centerX = canvas.width / 2;
            var centerY = canvas.height / 2;
            var radius = canvas.width / 3;

            context.beginPath();
            context.arc(centerX, centerY, radius, 0, 2 * Math.PI, false);
            context.fillStyle = 'yellow';
            context.fill();
            context.lineWidth = radius / 20;
            context.strokeStyle = '#000000';
            context.stroke();

            const img = new Image();
            img.onload = function() {
                const height = canvas.height / 2;
                const width = canvas.width / 2;
                context.drawImage(img, centerX - height / 2, centerY - width / 2, height, width);
            }
            img.setAttribute('crossOrigin', 'anonymous');
            img.src = "https://i.ibb.co/NxNvnK7/evil-smiley.png";

            var fontSize = Math.floor(canvas.height * 0.05) + "px ";
            context.font = fontSize + "Varela Round";
            context.textAlign = "center";

            context.fillStyle = "black";
            const upper = document.getElementById('upperTextInput').value;
            const lower = document.getElementById('lowerTextInput').value;
            var upperLen = context.measureText(upper);
            var lowerLen = context.measureText(lower);
            var radius = canvas.height / 4.5;
            var upperAngle = Math.PI * upperLen.width / 55 / canvas.height * 100; // radians
            drawTextAlongArc(context, upper, centerX, centerY, radius, upperAngle);
            var lowerAngle = Math.PI * lowerLen.width / 55 / canvas.height * 100; // radians
            drawTextAlongArc(context, lower, centerX, centerY, radius, lowerAngle, false);
        }

        function downloadImage() {
            var download = document.getElementById("download");
            var image = document.getElementById("smileCanvas").toDataURL("image/png")
                .replace("image/png", "image/octet-stream");
            download.setAttribute("href", image);
        }

        $(document).ready(function() {
            $(window).resize(smileCanvas);

            smileCanvas();
        });

        $("#upperTextInput").on('change keydown paste input', function() {
            smileCanvas();
        });

        $("#lowerTextInput").on('change keydown paste input', function() {
            smileCanvas();
        });
    </script>
</body>

</html>
